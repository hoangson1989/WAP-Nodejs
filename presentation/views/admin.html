<!-- admin.ejs -->
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<title>Admin Page</title>
		<style>
			table {
				border-collapse: collapse;
				width: 100%;
			}
			th,
			td {
				border: 1px solid #000; /* Solid border */
				text-align: left;
				padding: 8px;
			}
			th {
				background-color: #f2f2f2;
			}
			.pagination {
				display: flex;
				justify-content: center;
				margin-top: 20px;
			}
			.pagination button {
				margin: 0 5px;
				cursor: pointer;
				padding: 5px 10px;
			}
			.active {
				background-color: #007bff;
				color: white;
			}
			/* CSS for current page button */
			.current-page {
				background-color: #007bff; /* Blue background color */
				color: white; /* Text color */
				font-weight: bold; /* Bold text font */
				border: 1px solid #007bff; /* Blue border */
				border-radius: 5px; /* Rounded corners */
				padding: 5px 10px; /* Padding */
				margin: 0 3px; /* Margin */
			}
		</style>
	</head>
	<body>
		<h1>Admin Page</h1>
		<button onclick="logout()">Logout</button>
		<br><hr>
		<label for="">Add more question: </label
		><button onclick="addRow()">Add</button>
		<br />
		<br />
		<label for="">Filter by Difficulty: </label>
		<select id="typeFilter" onchange="filterByType()">
			<option value="">All</option>
			<option value="easy">easy</option>
			<option value="medium">medium</option>
			<option value="hard">hard</option>
			<!-- Add more options for each type -->
		</select>
		<span id="filterCount"></span>
		<br />
		<br />
		<table id="dataTable">
			<thead>
				<tr>
					<th>Id</th>
					<th>Type</th>
					<th>Difficulty</th>
					<th>Category</th>
					<th>Question</th>
					<th>Correct Answer</th>
					<th>Incorrect Answers</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				<% questions.forEach(question => { %>
				<tr>
					<td><%= question.id %></td>
					<td><%= question.type %></td>
					<td><%= question.difficulty %></td>
					<td><%= question.category %></td>
					<td><%= question.question %></td>
					<td><%= question.correct_answer %></td>
					<td><%= question.incorrect_answers.join(', ') %></td>
					<td><button onclick="deleteRow(this)">Delete</button></td>
				</tr>
				<% }); %>
			</tbody>
		</table>
		<div class="pagination">
			<button id="prevBtn" onclick="prevPage()">Previous</button>
			<div id="pageButtons"></div>
			<button id="nextBtn" onclick="nextPage()">Next</button>
		</div>
		<script>
			function logout() {
				console.log('logout click')
				$.post('/userAction', {
					"action" : "Logout"
				})
				.done((res)=>{
					window.location.href = '/'
				})
			}
			// Function to add a new row
			function addRow() {
				const table = document
					.getElementById("dataTable")
					.getElementsByTagName("tbody")[0];
				const newRow = table.insertRow(table.rows.length);

				// Insert cells with input fields
				const cellCount = 8; // Assuming 8 cells per row
				for (let i = 0; i < cellCount; i++) {
					const cell = newRow.insertCell(i);
					if (i === cellCount - 1) {
						// Add save button in the last cell
						const saveBtn = document.createElement("button");
						saveBtn.textContent = "Save";
						saveBtn.onclick = () => saveRow(newRow);
						cell.appendChild(saveBtn);
					} else {
						// Add input fields for other cells
						const input = document.createElement("input");
						input.type = "text";
						input.placeholder = "Enter value";
						cell.appendChild(input);
					}
				}
				// Scroll to the newly inserted row
				window.scrollTo(0, document.body.scrollHeight);
			}

			function deleteRow(button) {
				const row = button.parentNode.parentNode;
				const id = row.cells[0].textContent; // Assuming ID is in the first cell
				const confirmation = confirm(
					"Are you sure you want to delete this question?"
				);

				if (confirmation) {
					// Send an AJAX request to delete the question
					const xhr = new XMLHttpRequest();
					xhr.open("POST", "/admin/deleteQuestion", true);
					xhr.setRequestHeader("Content-Type", "application/json");
					xhr.onload = function () {
						if (xhr.status === 200) {
							console.log("Question deleted successfully");
							// Remove the row from the UI after successful deletion
							row.parentNode.removeChild(row);
						} else {
							console.error("Error deleting question");
						}
					};
					xhr.send(JSON.stringify({ id: id }));
				}
			}

			// Function to save data from a row
			function saveRow(row) {
				const inputs = row.querySelectorAll('input[type="text"]');
				const rowData = Array.from(inputs).map((input) => input.value);

				// Send data to server
				fetch("/admin/addQuestion", {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
					},
					body: JSON.stringify({ rowData: rowData }),
				})
					.then((response) => {
						if (response.ok) {
							console.log("Question added successfully");
							// Redirect to admin page after successful save
							window.location.href = "/admin";
						} else {
							console.error("Error adding question");
						}
					})
					.catch((error) => console.error("Error:", error));
			}

			// Function to filter questions by type
			function filterByType() {
				const selectedType = document.getElementById("typeFilter").value;
				const rows = document
					.getElementById("dataTable")
					.getElementsByTagName("tr");
				let count = 0; // Variable to store the count of filtered rows

				for (let i = 1; i < rows.length; i++) {
					// Start from index 1 to skip the header row
					const typeCell = rows[i].cells[2]; // Assuming type is in the second cell of each row

					if (selectedType === "" || typeCell.textContent === selectedType) {
						rows[i].style.display = "";
						count++; // Increment the count if the row matches the filter
					} else {
						rows[i].style.display = "none";
					}
				}

				// Update the filter count in the HTML
				document.getElementById("filterCount").textContent = `(${count} result${
					count !== 1 ? "s" : ""
				})`;
			}
			//PAGINATION
			let currentPage = 1; // Current page number
			const rowsPerPage = 100; // Number of rows per page

			// Function to get total number of pages based on total number of rows
			function getTotalPages() {
				const totalRows =
					document.getElementById("dataTable").getElementsByTagName("tr")
						.length - 1; // Exclude header row
				return Math.ceil(totalRows / rowsPerPage);
			}

			// Function to display rows for the current page
			function displayRows() {
				const rows = document
					.getElementById("dataTable")
					.getElementsByTagName("tr");
				const startIndex = (currentPage - 1) * rowsPerPage + 1; // Start index of rows for current page
				const endIndex = Math.min(
					startIndex + rowsPerPage - 1,
					rows.length - 1
				); // End index of rows for current page

				for (let i = 1; i < rows.length; i++) {
					rows[i].style.display =
						i >= startIndex && i <= endIndex ? "" : "none";
				}

				updatePaginationButtons(); // Update pagination buttons
			}

			// Function to navigate to previous page
			function prevPage() {
				if (currentPage > 1) {
					currentPage--;
					displayRows();
				}
			}

			// Function to navigate to next page
			function nextPage() {
				if (currentPage < getTotalPages()) {
					currentPage++;
					displayRows();
				}
			}

			// Function to generate page number buttons
			function generatePageButtons() {
				const pageButtonsContainer = document.getElementById("pageButtons");
				pageButtonsContainer.innerHTML = ""; // Clear existing buttons

				const totalPages = getTotalPages();

				// Generate button for previous page
				if (!document.getElementById("prevBtn")) {
					const prevBtn = document.createElement("button");
					prevBtn.textContent = "Previous";
					prevBtn.id = "prevBtn";
					prevBtn.onclick = prevPage;
					pageButtonsContainer.appendChild(prevBtn);
				}

				// Calculate the range of page numbers to display
				let startPage = Math.max(1, currentPage - 3);
				let endPage = Math.min(totalPages, currentPage + 3);

				// Adjust startPage and endPage if there are less than 6 pages in total
				if (totalPages < 6) {
					startPage = 1;
					endPage = totalPages;
				} else {
					if (currentPage < 4) {
						endPage = 6;
					} else if (currentPage > totalPages - 3) {
						startPage = totalPages - 5;
					}
				}

				// Generate buttons for the page numbers
				for (let i = startPage; i <= endPage; i++) {
					const button = document.createElement("button");
					button.textContent = i;
					button.onclick = function () {
						currentPage = i;
						displayRows();
					};
					if (i === currentPage) {
						button.classList.add("current-page"); // Add CSS class for current page button
					}
					pageButtonsContainer.appendChild(button);
				}

				// Generate button for next page
				if (!document.getElementById("nextBtn")) {
					const nextBtn = document.createElement("button");
					nextBtn.textContent = "Next";
					nextBtn.id = "nextBtn";
					nextBtn.onclick = nextPage;
					pageButtonsContainer.appendChild(nextBtn);
				}
			}

			// Function to update pagination buttons based on current page
			function updatePaginationButtons() {
				const prevBtn = document.getElementById("prevBtn");
				const nextBtn = document.getElementById("nextBtn");

				prevBtn.style.display = currentPage == 1 ? "none" : "inline";
				nextBtn.style.display =
					currentPage == getTotalPages() ? "none" : "inline";

				generatePageButtons(); // Generate page number buttons
			}

			// Initial display of rows and pagination buttons
			displayRows();
		</script>
	</body>
</html>
